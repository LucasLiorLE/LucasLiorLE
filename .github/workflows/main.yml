# GitHub Action for generating a contribution graph with a snake and a countdown.

name: Generate Snake + Countdown

# Controls when the action will run. This action runs every 6 hours.
on:
  schedule:
    # every 6 hours
    - cron: "0 */6 * * *"

# This command allows us to run the Action automatically from the Actions tab.
  workflow_dispatch:

jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:

      # Checks repo under $GITHUB_WORKSHOP, so your job can access it
      - uses: actions/checkout@v3

      # Prepare dist folders
      - name: Prepare dist folder
        run: |
          rm -rf dist
          mkdir -p dist/countdown
          mkdir -p dist/snake

      # Generates the snake  
      - uses: Platane/snk@v3
        id: snake-gif
        with:
          github_user_name: ${{ github.repository_owner }}
          # Generate files inside dist/snake
          outputs: |
            dist/snake/github-contribution-grid-snake.gif
            dist/snake/github-contribution-grid-snake.svg
            dist/snake/github-contribution-grid-snake-dark.svg?palette=github-dark
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Generates the countdown SVG
      - name: Generate countdown SVG
        run: |
          node - <<'EOF'
          const fs = require('fs');
          const now = new Date();

          //events
          const events = [
            { name: "Halloween", month: 10, day: 31 },
            { name: "Christmas", month: 12, day: 25 },
            { name: "New Year's Day", month: 1, day: 1 },
            { name: "My Birthday", month: 1, day: 22 }
          ];

          function getNextDate(ev, base) {
            let y = base.getFullYear();
            let d = new Date(y, ev.month - 1, ev.day);
            if (d <= base) d = new Date(y + 1, ev.month - 1, ev.day);
            return d;
          }

          // pick nearest event
          let nearest = null;
          let minDiff = Infinity;
          for (const ev of events) {
            const d = getNextDate(ev, now);
            const diff = d - now;
            if (diff < minDiff) {
              minDiff = diff;
              nearest = { name: ev.name, date: d };
            }
          }

          // compute remaining time
          let diff = nearest.date - now;
          const days = Math.floor(diff / (1000*60*60*24));
          diff -= days * (1000*60*60*24);
          const hours = Math.floor(diff / (1000*60*60));

          function pad(n){ return String(n).padStart(2,'0'); }

          const svg = `
          <svg width="400" height="140" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="#0d1117"/>
            <text x="50%" y="25%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="#ff8800">
              Countdown to ${nearest.name}
            </text>
            <text x="50%" y="45%" dominant-baseline="middle" text-anchor="middle" font-size="14" fill="#cccccc">
              ${nearest.date.toDateString()}
            </text>
            <text x="50%" y="75%" dominant-baseline="middle" text-anchor="middle" font-size="28" fill="#ffffff">
              ${days}d ${pad(hours)}h
            </text>
          </svg>
          `;

          fs.writeFileSync('dist/countdown/countdown.svg', svg.trim());
          EOF

      # show the status of the build. Makes it easier for debugging (if there's any issues).
      - name: Show build status
        run: git status

      # Push both snake and countdown files to output branch
      - name: Push new files to output branch
        uses: crazy-max/ghaction-github-pages@v3.1.0
        with:
          target_branch: output
          build_dir: dist
          commit_message: Update snake and countdown
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
